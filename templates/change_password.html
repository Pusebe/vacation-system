{% extends "base.html" %}

{% block title %}Cambiar Contraseña - Sistema de Vacaciones{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    Cambiar Contraseña
                </h2>
                <div class="text-muted">
                    Actualiza tu contraseña de acceso al sistema
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-key me-2"></i>
                            Cambiar Contraseña
                        </h3>
                    </div>
                    <form method="POST" action="{{ url_for('auth.change_password') }}" id="changePasswordForm">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Contraseña actual</label>
                                    <div class="input-group">
                                        <input type="password" name="current_password" class="form-control" 
                                               placeholder="Tu contraseña actual" required id="currentPassword">
                                        <button type="button" class="btn btn-outline-secondary" 
                                                onclick="togglePassword('currentPassword', this)">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <label class="form-label">Nueva contraseña</label>
                                    <div class="input-group">
                                        <input type="password" name="new_password" class="form-control" 
                                               placeholder="Tu nueva contraseña" required id="newPassword"
                                               minlength="6">
                                        <button type="button" class="btn btn-outline-secondary" 
                                                onclick="togglePassword('newPassword', this)">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-hint">Mínimo 6 caracteres</div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <label class="form-label">Confirmar nueva contraseña</label>
                                    <div class="input-group">
                                        <input type="password" name="confirm_password" class="form-control" 
                                               placeholder="Repite tu nueva contraseña" required id="confirmPassword"
                                               minlength="6">
                                        <button type="button" class="btn btn-outline-secondary" 
                                                onclick="togglePassword('confirmPassword', this)">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Indicador de fortaleza de contraseña -->
                                <div class="col-12 mb-3">
                                    <div class="password-strength" id="passwordStrength" style="display: none;">
                                        <label class="form-label small">Fortaleza de la contraseña:</label>
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar" id="strengthBar" 
                                                 role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="strengthText">Escribe una contraseña</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary">
                                <i class="ti ti-arrow-left me-2"></i>
                                Volver al Dashboard
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="ti ti-check me-2"></i>
                                Cambiar Contraseña
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Consejos de seguridad -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-shield-check me-2"></i>
                            Consejos de Seguridad
                        </h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="ti ti-check text-success me-2"></i>
                                Usa al menos 8 caracteres
                            </li>
                            <li class="mb-2">
                                <i class="ti ti-check text-success me-2"></i>
                                Combina letras, números y símbolos
                            </li>
                            <li class="mb-2">
                                <i class="ti ti-check text-success me-2"></i>
                                Evita información personal
                            </li>
                            <li class="mb-2">
                                <i class="ti ti-check text-success me-2"></i>
                                No uses la misma contraseña en otros sitios
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'ti ti-eye-off';
    } else {
        input.type = 'password';
        icon.className = 'ti ti-eye';
    }
}

function checkPasswordStrength(password) {
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const strengthDiv = document.getElementById('passwordStrength');
    
    if (password.length === 0) {
        strengthDiv.style.display = 'none';
        return;
    }
    
    strengthDiv.style.display = 'block';
    
    let score = 0;
    let feedback = [];
    
    // Longitud
    if (password.length >= 8) score += 25;
    else feedback.push('al menos 8 caracteres');
    
    // Mayúsculas
    if (/[A-Z]/.test(password)) score += 25;
    else feedback.push('una mayúscula');
    
    // Números
    if (/[0-9]/.test(password)) score += 25;
    else feedback.push('un número');
    
    // Símbolos
    if (/[^A-Za-z0-9]/.test(password)) score += 25;
    else feedback.push('un símbolo');
    
    // Actualizar barra
    strengthBar.style.width = score + '%';
    
    if (score < 50) {
        strengthBar.className = 'progress-bar bg-danger';
        strengthText.textContent = 'Débil - Añade: ' + feedback.join(', ');
    } else if (score < 75) {
        strengthBar.className = 'progress-bar bg-warning';
        strengthText.textContent = 'Media - Añade: ' + feedback.join(', ');
    } else if (score < 100) {
        strengthBar.className = 'progress-bar bg-info';
        strengthText.textContent = 'Buena - Añade: ' + feedback.join(', ');
    } else {
        strengthBar.className = 'progress-bar bg-success';
        strengthText.textContent = '¡Excelente!';
    }
}

function validatePasswords() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const confirmInput = document.getElementById('confirmPassword');
    
    if (newPassword && confirmPassword) {
        if (newPassword === confirmPassword) {
            confirmInput.classList.remove('is-invalid');
            confirmInput.classList.add('is-valid');
        } else {
            confirmInput.classList.remove('is-valid');
            confirmInput.classList.add('is-invalid');
        }
    } else {
        confirmInput.classList.remove('is-valid', 'is-invalid');
    }
}

// Event listeners
document.getElementById('newPassword').addEventListener('input', function() {
    checkPasswordStrength(this.value);
    validatePasswords();
});

document.getElementById('confirmPassword').addEventListener('input', validatePasswords);

// Validación del formulario
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('Las contraseñas no coinciden');
        return false;
    }
    
    if (newPassword.length < 6) {
        e.preventDefault();
        alert('La contraseña debe tener al menos 6 caracteres');
        return false;
    }
});
</script>
{% endblock %}